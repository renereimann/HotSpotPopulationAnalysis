#!/usr/bin/env python

import cPickle, os, argparse, time
import numpy as np
from utils import HPA_analysis, BackgroundLocalWarmSpotPool, SingleSpotTrialPool, SignalSimulation
from data_types import LocalWarmSpotExpectation
from source_count_dist import SourceCountDistEqualFluxAtEarth, SourceCountDistFIRESONG
from numpy.lib.recfunctions import append_fields

# get arguments
parser = argparse.ArgumentParser()
parser.add_argument("--infile_signal",
                        type=str,
                        default="test_data/signal_pool.cPickle",
                        help="Give indir for signal signal.")
parser.add_argument("--infile_background",
                        type=str,
                        default="test_data/background_pool.pickle",
                        help="Give indir for background.")
parser.add_argument("--expectation",
                        type=str,
                        default="test_data/from_poisson_test/HPA_nspot_expectation.pickle",
                        help="Give path to expectation spline")
parser.add_argument("--outdir",
                        type=str,
                        default="test_data/",
                        help="Give outpath.")
parser.add_argument("--n_iter",
                    type=int,
                    default=100,
                    help="Number of iteration to perform for these settings.")
parser.add_argument("--seed",
                    type=int,
                    default=None,
                    help="Number of iteration to perform for these settings.")
parser.add_argument("--nsrc",
                    type=int,
                    default=None,
                    help="Job config_id to perform on")
parser.add_argument("--n_inj",
                    type=float,
                    default=None,
                    help="Job config_id to perform on")
parser.add_argument("--infile_source_count",
                    type=str,
                    default=None,
                    help="Input file with that was generated by firesong")
parser.add_argument("--density",
                    type=float,
                    default=None,
                    help="Density of sources.")
args = parser.parse_args()

print "Run", os.path.realpath(__file__)
print "Use arguments:", args
print

RNG = np.random.RandomState(args.seed)
seed_bgd, seed_sig, seed_source_count = RNG.randint(0, np.iinfo(np.uint32).max, size=3)

print("Load expectation ...")
expect = LocalWarmSpotExpectation(load_path=args.expectation)

print("Load background pool ...")
bgd_pool = BackgroundLocalWarmSpotPool()
bgd_pool.load(args.infile_background, seed=seed_bgd)

print("Load signal pool ...")
sig_pool = SingleSpotTrialPool()
sig_pool.load(args.infile_signal, seed=seed_sig)

print("Setup source count distribution ...")
source_count = None
if args.n_inj is not None and args.nsrc is not None:
    source_count = SourceCountDistEqualFluxAtEarth(phi_inj=args.n_inj, n_sources=args.nsrc)
elif args.infile_source_count is not None:
    source_count = SourceCountDistFIRESONG(infile=args.infile_source_count, density=None)
else:
    raise NotImplementedError("You need to either give --n_inj and --nsrc or --infile_source_cout")

print("Setup simulation ...")
sim = SignalSimulation( seed=None,
                        background_pool=bgd_pool,
                        single_spot_pool=sig_pool,
                        source_count_dist=source_count,
                        min_ang_dist=1.,
                        dec_range=[-3,90],
                        log10pVal_threshold=2.)

print("Setup analysis ...")
analysis = HPA_analysis(expect)

#### start generating stuff
print("Start generating trials ...")

t0 = time.time()
out = []
hottest_source = []
n_above = []
while len(out) < args.n_iter:
    kwargs = {}
    data, n_tot_inj = sim.get_pseudo_experiment(**kwargs)
    hottest_source.append(np.max(data))
    n_above.append(data >= 6.542) # 5 sigma p-values
    pseudo_result = analysis.best_fit(data)

    dtype = [("n_inj", np.int), ("logP", np.float), ("pVal", np.float),
             ("count", np.int), ("exp", np.float)]

    out.append(np.array((n_tot_inj, ) + pseudo_result.tolist(), dtype=dtype))
print("... done.")
out = np.concatenate([out])
# double check that there are no nan pvalues
m = np.isfinite(out["logP"])
if np.any(~m):
    print("Found infinite logP: {0:d} of {1:d}".format(np.count_nonzero(~m), len(m)))
    for n in out.dtype.names:
        print(out[~m][n])
out = out[m]
print(time.time()-t0, "sec")

print out[:10]
print "..."
print out[-10:]
# save stuff
print("Save results")
config = str(source_count)
with open(os.path.join(args.outdir,"HPA_signal_trials_{config}.npy".format(**locals())), "w") as open_file:
    np.save(open_file, out)
with open(os.path.join(args.outdir,"HPA_signal_trials_{config}.args".format(**locals())), "w") as open_file:
    cPickle.dump(args, open_file, protocol=2)
with open(os.path.join(args.outdir,"HPA_signal_trials_{config}_hottest_source.cPickle".format(**locals())), "w") as open_file:
    cPickle.dump(hottest_source, open_file, protocol=2)
with open(os.path.join(args.outdir,"HPA_signal_trials_{config}_n_above.cPickle".format(**locals())), "w") as open_file:
    cPickle.dump(n_above, open_file, protocol=2)
